# Partie 1 : Mise en place et ma√Ætrise du serveur Web

Dans cette partie on va installer le serveur web, et prendre un peu la ma√Ætrise dessus, en regardant o√π il stocke sa conf, ses logs, etc. Et en manipulant un peu tout √ßa bien s√ªr.

On va installer un serveur Web tr√®s tr√®s tr√®√®√®s utilis√© autour du monde : le serveur Web Apache.

- [Partie 1 : Mise en place et ma√Ætrise du serveur Web](#partie-1--mise-en-place-et-ma√Ætrise-du-serveur-web)
  - [1. Installation](#1-installation)
  - [2. Avancer vers la ma√Ætrise du service](#2-avancer-vers-la-ma√Ætrise-du-service)

![Tipiii](../pics/linux_is_a_tipi.jpg)

## 1. Installation

üñ•Ô∏è **VM web.tp5.linux**

**N'oubliez pas de d√©rouler la [üìù**checklist**üìù](../README.md#checklist).**

| Machine         | IP            | Service     |
|-----------------|---------------|-------------|
| `web.tp5.linux` | `10.105.1.11` | Serveur Web |

üåû **Installer le serveur Apache**

- paquet `httpd`
- la conf se trouve dans `/etc/httpd/`
  - le fichier de conf principal est `/etc/httpd/conf/httpd.conf`
  - je vous conseille **vivement** de virer tous les commentaire du fichier, √† d√©faut de les lire, vous y verrez plus clair
    - avec `vim` vous pouvez tout virer avec `:g/^ *#.*/d`

> Ce que j'entends au-dessus par "fichier de conf principal" c'est que c'est **LE SEUL** fichier de conf lu par Apache quand il d√©marre. C'est souvent comme √ßa : un service ne lit qu'un unique fichier de conf pour d√©marrer. Cherchez pas, on va toujours au plus simple. Un seul fichier, c'est simple.  
**En revanche** ce serait le bordel si on mettait toute la conf dans un seul fichier pour pas mal de services.  
Donc, le principe, c'est que ce "fichier de conf principal" d√©finit g√©n√©ralement deux choses. D'une part la conf globale. D'autre part, il inclut d'autres fichiers de confs plus sp√©cifiques.  
On a le meilleur des deux mondes : simplicit√© (un seul fichier lu au d√©marrage) et la propret√© (√©clater la conf dans plusieurs fichiers).

üåû **D√©marrer le service Apache**

- le service s'appelle `httpd` (raccourci pour `httpd.service` en r√©alit√©)
  - d√©marrez-le
  - faites en sorte qu'Apache d√©marre automatiquement au d√©marrage de la machine
    - √ßa se fait avec une commande `systemctl` r√©f√©rez-vous au m√©mo
  - ouvrez le port firewall n√©cessaire
    - utiliser une commande `ss` pour savoir sur quel port tourne actuellement Apache
    - une portion du m√©mo commandes est d√©di√©e √† `ss`

**En cas de probl√®me** (IN CASE OF FIIIIRE) vous pouvez check les logs d'Apache :

```bash
# Demander √† systemd les logs relatifs au service httpd
$ sudo journalctl -xe -u httpd

# Consulter le fichier de logs d'erreur d'Apache
$ sudo cat /var/log/httpd/error_log

# Il existe aussi un fichier de log qui enregistre toutes les requ√™tes effectu√©es sur votre serveur
$ sudo cat /var/log/httpd/access_log
```

üåû **TEST**

- v√©rifier que le service est d√©marr√©
- v√©rifier qu'il est configur√© pour d√©marrer automatiquement
- v√©rifier avec une commande `curl localhost` que vous joignez votre serveur web localement
- v√©rifier depuis votre PC que vous acc√©der √† la page par d√©faut
  - avec votre navigateur (sur votre PC)
  - avec une commande `curl` depuis un terminal de votre PC (je veux √ßa dans le compte-rendu, pas de screen)

## 2. Avancer vers la ma√Ætrise du service

üåû **Le service Apache...**

- affichez le contenu du fichier `httpd.service` qui contient la d√©finition du service Apache

üåû **D√©terminer sous quel utilisateur tourne le processus Apache**

- mettez en √©vidence la ligne dans le fichier de conf principal d'Apache (`httpd.conf`) qui d√©finit quel user est utilis√©
- utilisez la commande `ps -ef` pour visualiser les processus en cours d'ex√©cution et confirmer que apache tourne bien sous l'utilisateur mentionn√© dans le fichier de conf
  - filtrez les infos importantes avec un `| grep`
- la page d'accueil d'Apache se trouve dans `/usr/share/testpage/`
  - v√©rifiez avec un `ls -al` que tout son contenu est **accessible en lecture** √† l'utilisateur mentionn√© dans le fichier de conf

üåû **Changer l'utilisateur utilis√© par Apache**

- cr√©ez un nouvel utilisateur
  - pour les options de cr√©ation, inspirez-vous de l'utilisateur Apache existant
    - le fichier `/etc/passwd` contient les informations relatives aux utilisateurs existants sur la machine
    - servez-vous en pour voir la config actuelle de l'utilisateur Apache par d√©faut (son homedir et son shell en particulier)
- modifiez la configuration d'Apache pour qu'il utilise ce nouvel utilisateur
  - montrez la ligne de conf dans le compte rendu, avec un `grep` pour ne montrer que la ligne importante
- red√©marrez Apache
- utilisez une commande `ps` pour v√©rifier que le changement a pris effet
  - vous devriez voir un processus au moins qui tourne sous l'identit√© de votre nouvel utilisateur

üåû **Faites en sorte que Apache tourne sur un autre port**

- modifiez la configuration d'Apache pour lui demander d'√©couter sur un autre port de votre choix
  - montrez la ligne de conf dans le compte rendu, avec un `grep` pour ne montrer que la ligne importante
- ouvrez ce nouveau port dans le firewall, et fermez l'ancien
- red√©marrez Apache
- prouvez avec une commande `ss` que Apache tourne bien sur le nouveau port choisi
- v√©rifiez avec `curl` en local que vous pouvez joindre Apache sur le nouveau port
- v√©rifiez avec votre navigateur que vous pouvez joindre le serveur sur le nouveau port

üìÅ **Fichier `/etc/httpd/conf/httpd.conf`**

‚ûú **Si c'est tout bon vous pouvez passer √† [la partie 2.](../part2/README.md)**